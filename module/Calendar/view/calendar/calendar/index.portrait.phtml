<?php
$reservations = $this->get('reservations');
$events = $this->get('events');

$reservationsForColPlugin = $this->plugin('CalendarReservationsForCol');
$reservationsCleanupPlugin = $this->plugin('CalendarReservationsCleanup');

$eventsForColPlugin = $this->plugin('CalendarEventsForCol');
$eventsCleanupPlugin = $this->plugin('CalendarEventsCleanup');
?>

<!-- Modern Calendar Container -->
<div class="modern-calendar-container">

    <!-- Desktop Grid View -->
    <div class="modern-calendar-desktop">
        <!-- Grid Header -->
        <div class="modern-calendar-header">
            <div class="modern-calendar-time-header"></div>
            <?php foreach ($this->squares as $square): ?>
                <div class="modern-calendar-court-header">
                    <?= $this->t($square->need('name')) ?>
                </div>
            <?php endforeach; ?>
        </div>

        <!-- Time Slot Rows -->
        <?php for ($walkingTime = $this->timeStart; $walkingTime < $this->timeEnd; $walkingTime += $this->timeBlock): ?>
            <div class="modern-calendar-row">
                <div class="modern-calendar-time-slot">
                    <?= $this->timeFormat($walkingTime, false, 'UTC') ?>
                </div>

                <?php foreach ($this->squares as $square): ?>
                    <?php
                    $walkingDate = clone $this->dateStart;
                    $walkingDate->modify('+' . $walkingTime . ' sec');

                    $reservationsForCol = $reservationsForColPlugin($reservations, $walkingDate, $walkingTime, $this->timeBlock);
                    $eventsForCol = $eventsForColPlugin($events, $walkingDate, $walkingTime, $this->timeBlock);

                    $cellContent = $this->calendarCellLogic($walkingDate, $walkingTime, $this->timeBlock, $this->dateNow, $square, $this->user, $reservationsForCol, $eventsForCol);

                    // Extract the content and determine the status
                    $isFree = strpos($cellContent, 'cc-free') !== false;
                    $isBooked = strpos($cellContent, 'cc-single') !== false;
                    $isMultiple = strpos($cellContent, 'cc-multiple') !== false;
                    $isOwn = strpos($cellContent, 'cc-own') !== false;
                    $isConflict = strpos($cellContent, 'cc-conflict') !== false;
                    $isOver = strpos($cellContent, 'cc-over') !== false;

                    // Extract the link if it's clickable
                    preg_match('/href="([^"]+)"/', $cellContent, $matches);
                    $link = isset($matches[1]) ? $matches[1] : null;

                    // Extract the text content
                    preg_match('/<[^>]*>([^<]+)<\/[^>]*>/', $cellContent, $matches);
                    $text = isset($matches[1]) ? trim($matches[1]) : 'Free';

                    // Determine status class
                    $statusClass = 'modern-calendar-status-past';
                    if ($isFree) $statusClass = 'modern-calendar-status-free';
                    elseif ($isBooked) $statusClass = 'modern-calendar-status-booked';
                    elseif ($isMultiple) $statusClass = 'modern-calendar-status-multiple';
                    elseif ($isOwn) $statusClass = 'modern-calendar-status-own';
                    elseif ($isConflict) $statusClass = 'modern-calendar-status-conflict';
                    elseif ($isOver) $statusClass = 'modern-calendar-status-closed';
                    ?>

                    <div class="modern-calendar-cell">
                        <?php if ($link && $isFree): ?>
                            <a href="<?= $link ?>" class="modern-calendar-slot <?= $statusClass ?>">
                                <?= $text ?>
                            </a>
                        <?php else: ?>
                            <div class="modern-calendar-slot <?= $statusClass ?>">
                                <?= $text ?>
                            </div>
                        <?php endif; ?>
                    </div>
                <?php endforeach; ?>
            </div>
        <?php endfor; ?>
    </div>

    <!-- Mobile & Tablet Tab View -->
    <div class="modern-calendar-mobile">
        <!-- Tab Headers -->
        <div class="modern-calendar-tabs">
            <?php foreach ($this->squares as $index => $square): ?>
                <button onclick="changeTab(<?= $index ?>)"
                    data-tab
                    class="modern-calendar-tab <?= $index === 0 ? 'modern-calendar-tab-active' : '' ?>">
                    <?= $this->t($square->need('name')) ?>
                </button>
            <?php endforeach; ?>
        </div>

        <!-- Tab Content Panels -->
        <div class="modern-calendar-tab-content">
            <?php foreach ($this->squares as $squareIndex => $square): ?>
                <div data-tab-content class="modern-calendar-panel <?= $squareIndex === 0 ? '' : 'modern-calendar-panel-hidden' ?>">
                    <h3 class="modern-calendar-panel-title"><?= $this->t($square->need('name')) ?></h3>
                    <div class="modern-calendar-panel-slots">
                        <?php for ($walkingTime = $this->timeStart; $walkingTime < $this->timeEnd; $walkingTime += $this->timeBlock): ?>
                            <?php
                            $walkingDate = clone $this->dateStart;
                            $walkingDate->modify('+' . $walkingTime . ' sec');

                            $reservationsForCol = $reservationsForColPlugin($reservations, $walkingDate, $walkingTime, $this->timeBlock);
                            $eventsForCol = $eventsForColPlugin($events, $walkingDate, $walkingTime, $this->timeBlock);

                            $cellContent = $this->calendarCellLogic($walkingDate, $walkingTime, $this->timeBlock, $this->dateNow, $square, $this->user, $reservationsForCol, $eventsForCol);

                            // Extract the content and determine the status
                            $isFree = strpos($cellContent, 'cc-free') !== false;
                            $isBooked = strpos($cellContent, 'cc-single') !== false;
                            $isMultiple = strpos($cellContent, 'cc-multiple') !== false;
                            $isOwn = strpos($cellContent, 'cc-own') !== false;
                            $isConflict = strpos($cellContent, 'cc-conflict') !== false;
                            $isOver = strpos($cellContent, 'cc-over') !== false;

                            // Extract the link if it's clickable
                            preg_match('/href="([^"]+)"/', $cellContent, $matches);
                            $link = isset($matches[1]) ? $matches[1] : null;

                            // Extract the text content
                            preg_match('/<[^>]*>([^<]+)<\/[^>]*>/', $cellContent, $matches);
                            $text = isset($matches[1]) ? trim($matches[1]) : 'Free';

                            // Determine status class
                            $statusClass = 'modern-calendar-status-past';
                            if ($isFree) $statusClass = 'modern-calendar-status-free';
                            elseif ($isBooked) $statusClass = 'modern-calendar-status-booked';
                            elseif ($isMultiple) $statusClass = 'modern-calendar-status-multiple';
                            elseif ($isOwn) $statusClass = 'modern-calendar-status-own';
                            elseif ($isConflict) $statusClass = 'modern-calendar-status-conflict';
                            elseif ($isOver) $statusClass = 'modern-calendar-status-closed';
                            ?>

                            <div class="modern-calendar-mobile-slot">
                                <span class="modern-calendar-mobile-time">
                                    <?= $this->timeFormat($walkingTime, false, 'UTC') ?> - <?= $this->timeFormat($walkingTime + $this->timeBlock, true, 'UTC', true) ?>
                                </span>
                                <div class="modern-calendar-mobile-status">
                                    <?php if ($link && $isFree): ?>
                                        <a href="<?= $link ?>" class="modern-calendar-mobile-button <?= $statusClass ?>">
                                            <?= $text ?>
                                        </a>
                                    <?php else: ?>
                                        <div class="modern-calendar-mobile-button <?= $statusClass ?>">
                                            <?= $text ?>
                                        </div>
                                    <?php endif; ?>
                                </div>
                            </div>
                        <?php endfor; ?>
                    </div>
                </div>
            <?php endforeach; ?>
        </div>
    </div>
</div>

<script>
    // Initialize tabs on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Set first tab as active by default
        const firstTab = document.querySelector('[data-tab]');
        const firstContent = document.querySelector('[data-tab-content]');

        if (firstTab && firstContent) {
            firstTab.classList.add('modern-calendar-tab-active');
            firstContent.classList.remove('modern-calendar-panel-hidden');
        }
    });

    function changeTab(tabIndex) {
        const tabs = document.querySelectorAll('[data-tab]');
        const contents = document.querySelectorAll('[data-tab-content]');

        // Check if the clicked tab is already active
        if (tabs[tabIndex] && tabs[tabIndex].classList.contains('modern-calendar-tab-active')) {
            return; // Don't do anything if the tab is already active
        }

        // Reset all tabs
        tabs.forEach(tab => {
            tab.classList.remove('modern-calendar-tab-active');
        });

        // Set active tab
        if (tabs[tabIndex]) {
            tabs[tabIndex].classList.add('modern-calendar-tab-active');
        }

        // Hide all content and show active
        contents.forEach(content => {
            content.classList.add('modern-calendar-panel-hidden');
        });

        if (contents[tabIndex]) {
            contents[tabIndex].classList.remove('modern-calendar-panel-hidden');
        }
    }
</script>

<style>
    /* Modern Calendar Styles - Completely Override Old CSS */
    .modern-calendar-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        border: 1px solid #e2e8f0;
        overflow: hidden;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    /* Desktop Grid Layout */
    .modern-calendar-desktop {
        display: none;
    }

    @media (min-width: 1024px) {
        .modern-calendar-desktop {
            display: grid;
            grid-template-columns: auto repeat(6, 1fr);
            border-collapse: collapse;
        }
    }

    .modern-calendar-header {
        display: contents;
    }

    .modern-calendar-time-header {
        background: #f8fafc;
        border-right: 1px solid #e2e8f0;
        border-bottom: 1px solid #e2e8f0;
        padding: 16px;
        font-weight: 600;
        color: #475569;
    }

    .modern-calendar-court-header {
        background: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
        border-left: 1px solid #e2e8f0;
        padding: 16px;
        text-align: center;
        font-weight: 700;
        font-size: 14px;
        color: #1e293b;
    }

    .modern-calendar-row {
        display: contents;
    }

    .modern-calendar-time-slot {
        background: #f8fafc;
        border-right: 1px solid #e2e8f0;
        border-top: 1px solid #e2e8f0;
        padding: 16px;
        text-align: right;
        font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
        font-size: 12px;
        color: #64748b;
        font-weight: 500;
    }

    .modern-calendar-cell {
        border-top: 1px solid #e2e8f0;
        border-left: 1px solid #e2e8f0;
        padding: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modern-calendar-slot {
        width: 100%;
        padding: 12px;
        text-align: center;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.2s ease;
        display: block;
        border: none;
        cursor: pointer;
    }

    /* Status Colors */
    .modern-calendar-status-free {
        background-color: #ecfdf5;
        color: #15803d;
    }

    .modern-calendar-status-free:hover {
        background-color: #d1fae5;
        transform: translateY(-1px);
    }

    .modern-calendar-status-booked {
        background-color: #fef2f2;
        color: #be123c;
    }

    .modern-calendar-status-multiple {
        background-color: #eff6ff;
        color: #1d4ed8;
    }

    .modern-calendar-status-own {
        background-color: #ecfdf5;
        color: #047857;
    }

    .modern-calendar-status-conflict {
        background-color: #fef2f2;
        color: #dc2626;
    }

    .modern-calendar-status-past {
        background-color: #f1f5f9;
        color: #64748b;
    }

    .modern-calendar-status-closed {
        background-color: #f1f5f9;
        color: #64748b;
    }

    /* Mobile Layout */
    .modern-calendar-mobile {
        display: block;
    }

    @media (min-width: 1024px) {
        .modern-calendar-mobile {
            display: none;
        }
    }

    .modern-calendar-tabs {
        background: #f1f5f9;
        border-bottom: 1px solid #e2e8f0;
        padding: 8px;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
        gap: 8px;
    }

    .modern-calendar-tab {
        background: white;
        border: none;
        border-radius: 8px;
        padding: 8px 12px;
        font-size: 12px;
        font-weight: 600;
        color: #64748b;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .modern-calendar-tab:hover {
        background: #f0fdf4;
        color: #15803d;
    }

    .modern-calendar-tab-active {
        background: #84cc16;
        color: white;
        box-shadow: 0 2px 4px rgba(132, 204, 22, 0.3);
    }

    .modern-calendar-tab-content {
        padding: 16px;
    }

    .modern-calendar-panel {
        display: block;
    }

    .modern-calendar-panel-hidden {
        display: none;
    }

    .modern-calendar-panel-title {
        font-size: 18px;
        font-weight: 700;
        color: #1e293b;
        margin: 0 0 16px 0;
    }

    .modern-calendar-panel-slots {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .modern-calendar-mobile-slot {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: #f8fafc;
        border-radius: 8px;
        padding: 12px;
    }

    .modern-calendar-mobile-time {
        font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
        font-size: 12px;
        color: #64748b;
        font-weight: 500;
    }

    .modern-calendar-mobile-status {
        width: 96px;
    }

    .modern-calendar-mobile-button {
        width: 100%;
        padding: 8px 12px;
        text-align: center;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.2s ease;
        display: block;
        border: none;
        cursor: pointer;
    }

    /* Override any existing calendar styles */
    .calendar-cell,
    .cc-label,
    .cc-free,
    .cc-single,
    .cc-multiple,
    .cc-own,
    .cc-conflict,
    .cc-over {
        all: unset !important;
    }
</style>