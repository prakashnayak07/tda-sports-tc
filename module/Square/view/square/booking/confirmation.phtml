<?php
// PHP logic remains unchanged
header('Cache-Control: no-cache, no-store, must-revalidate');
header('Pragma: no-cache');
header('Expires: 0');

$square = $this->square;
$squareType = $this->option('subject.square.type');
$dateStart = $this->dateStart;
$dateEnd = $this->dateEnd;
$dateDisplay = sprintf(
    '%s to %s',
    $dateStart->format('M d, Y, h:i A'),
    $dateEnd->format('h:i A')
);

$this->setup(array(
    'title' => sprintf('%s-%s', $squareType, $this->t('Booking')),
    'panel' => 'centered-panel',
    'messages' => array(
        'error' => $this->message,
    ),
    'back' => true,
));

$paymentRequired = false;
$paymentOptions = $this->option('service.pricing.payment', 'none');
$requiresPayment = (strpos($paymentOptions, 'stripe') !== false || strpos($paymentOptions, 'card') !== false);
$pricingSummary = $this->squarePricingSummary($dateStart, $dateEnd, $square, $this->quantityChoosen, $this->products);

// Debug code remains unchanged
$serviceManager = $this->getHelperPluginManager()->getServiceLocator();
$squarePricingManager = $serviceManager->get('Square\Manager\SquarePricingManager');
$actualPricing = $squarePricingManager->getFinalPricingInRange($dateStart, $dateEnd, $square, $this->quantityChoosen);

error_log("DEBUG - Date Start: " . $dateStart->format('Y-m-d H:i:s'));
error_log("DEBUG - Date End: " . $dateEnd->format('Y-m-d H:i:s'));
error_log("DEBUG - Square ID: " . $square->get('sid'));
error_log("DEBUG - Quantity: " . $this->quantityChoosen);
error_log("DEBUG - Actual Pricing: " . print_r($actualPricing, true));
error_log("DEBUG - Pricing Summary: " . ($pricingSummary ? 'YES' : 'NO'));
error_log("DEBUG - Payment Options: " . $paymentOptions);
error_log("DEBUG - Requires Payment: " . ($requiresPayment ? 'YES' : 'NO'));

if ($requiresPayment) {
    $hasCourtPricing = (bool)$actualPricing;
    $hasProductPricing = false;
    if (!empty($this->products)) {
        foreach ($this->products as $product) {
            if ($product->need('price') * $product->needExtra('amount') > 0) {
                $hasProductPricing = true;
                break;
            }
        }
    }
    $paymentRequired = $hasCourtPricing || $hasProductPricing;

    error_log("DEBUG - Has Court Pricing: " . ($hasCourtPricing ? 'YES' : 'NO'));
    error_log("DEBUG - Has Product Pricing: " . ($hasProductPricing ? 'YES' : 'NO'));
    error_log("DEBUG - Payment Required: " . ($paymentRequired ? 'YES' : 'NO'));
}
?>

<div class="h-auto bg-gradient-to-br from-slate-50 to-slate-100 flex items-center justify-center p-4">
    <div class="w-full max-w-md bg-white rounded-2xl shadow-lg overflow-hidden">
        <!-- Header -->
        <?php
        // echo '<div class="bg-gradient-to-r from-green-400 to-green-500 p-6 text-center">';
        // echo '<h1 class="text-2xl font-bold text-green-900">' . $this->t('Booking Summary') . '</h1>';
        // echo '<p class="text-green-800 mt-1">' . $this->t('Review your court reservation') . '</p>';
        // echo '</div>';
        ?>

        <!-- Form Content -->
        <form method="post" action="<?= $this->url ?>" class="p-6">
            <!-- Booking Details Card -->
            <div class="bg-slate-50 rounded-xl p-5 mb-6 border border-slate-200">
                <div class="flex items-start gap-4">

                    <div>
                        <h2 class="font-bold text-lg text-slate-900"><?= htmlspecialchars($square->get('name')) ?></h2>
                        <p class="text-slate-600"><?= $dateDisplay ?></p>
                    </div>
                </div>

                <?php if ($pricingSummary): ?>
                    <div class="mt-4 bg-white rounded-lg p-4 border border-slate-200">
                        <?= $pricingSummary ?>
                    </div>
                <?php endif; ?>
            </div>

            <!-- Rules & Notes Section -->
            <?php if ($square->getMeta('rules.document.file') || $square->getMeta('rules.text') || $square->get('allow_notes')): ?>
                <div class="bg-slate-50 rounded-xl p-5 mb-6 border border-slate-200">
                    <h3 class="font-bold text-slate-900 flex items-center gap-2 mb-4">
                        <span>üìù</span> <?= $this->t('Rules & Notes') ?>
                    </h3>

                    <?php if ($square->getMeta('rules.document.file')): ?>
                        <p class="mb-4">
                            <a href="<?= $this->basePath($square->getMeta('rules.document.file')) ?>" target="_blank" class="text-blue-600 hover:underline">
                                <?= $this->t('Please read our rules document before proceeding.') ?>
                            </a>
                        </p>
                        <div class="flex items-start gap-2 mb-4">
                            <input type="checkbox" name="bf-accept-rules-document" id="bf-accept-rules-document" required class="mt-1">
                            <label for="bf-accept-rules-document" class="text-slate-700">
                                <?= sprintf($this->t('Yes, I have %1$sread and accepted%2$s the "%3$s"'), '<span class="font-semibold">', '</span>', htmlspecialchars($square->getMeta('rules.document.name', $this->t('Rules-document')))) ?>
                            </label>
                        </div>
                    <?php endif; ?>

                    <?php if ($square->getMeta('rules.text')): ?>
                        <div class="mb-4 text-slate-700"><?= $square->getMeta('rules.text') ?></div>
                        <div class="flex items-start gap-2 mb-4">
                            <input type="checkbox" name="bf-accept-rules-text" id="bf-accept-rules-text" required class="mt-1">
                            <label for="bf-accept-rules-text" class="text-slate-700">
                                <?= sprintf($this->t('Yes, I have %sread and accepted%s these rules and notes'), '<span class="font-semibold">', '</span>') ?>
                            </label>
                        </div>
                    <?php endif; ?>

                    <?php if ($square->get('allow_notes')): ?>
                        <textarea name="bf-user-notes" class="w-full p-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-green-400 focus:border-green-400" rows="3" placeholder="<?= $this->t('Optional notes for your booking') ?>"></textarea>
                    <?php endif; ?>
                </div>
            <?php endif; ?>

            <!-- Payment Notice -->
            <?php if ($paymentRequired): ?>
                <div class="bg-indigo-50 border border-indigo-200 rounded-xl p-4 mb-6 flex items-start gap-3">

                    <p class="text-indigo-800 text-xs">
                        <span class="font-semibold"><?= $this->t('Payment Required') ?>:</span>
                        <?= $this->t('You will be redirected to our secure payment processor to complete this booking.') ?>
                    </p>
                </div>
            <?php endif; ?>

            <!-- Form Footer -->
            <div class="mt-8">
                <?php
                $submissionToken = 'booking_' . uniqid() . '_' . time();
                $session = new \Zend\Session\Container('booking_tokens');
                $session->offsetSet($submissionToken, true);
                ?>
                <input type="hidden" name="bf-confirm" value="<?= sha1('Quick and dirty' . floor(time() / 1800)) ?>">
                <input type="hidden" name="bf-submission-token" value="<?= $submissionToken ?>">

                <button type="submit" name="bf-submit" class="w-full text-white bg-[#93b353] hover:bg-green-900 font-bold py-4 px-6 rounded-xl transition-all duration-300 transform hover:scale-[1.02] active:scale-[0.98] shadow-md hover:shadow-lg">
                    <?= $paymentRequired ? $this->t('Proceed to Payment') : $this->t('Complete Booking') ?>
                </button>

                <?php if ($paymentRequired): ?>
                    <div class="flex items-center justify-center gap-2 mt-4 text-slate-500 text-sm">
                        <?= $this->t('Secure payment via') ?> <span class="font-semibold text-indigo-600">Stripe</span>
                    </div>
                <?php endif; ?>
            </div>
        </form>
    </div>
</div>